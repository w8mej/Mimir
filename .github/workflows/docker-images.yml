
name: Build & Push Docker Images
on:
  push: { branches: [ main ], paths: ['docker/**','coordinator/**','client/**','mpclib/**','model/**','requirements.txt'] }
  workflow_dispatch: {}
env:
  IMAGE_NAME_COORD: mpcprompt/coordinator
  IMAGE_NAME_WEBUI: mpcprompt/webui
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with: { registry: ghcr.io, username: ${{ github.actor }}, password: ${{ secrets.GITHUB_TOKEN }} }
      - uses: docker/build-push-action@v6
        with: { context: '.', file: 'docker/Dockerfile.coordinator', push: true, tags: 'ghcr.io/${{ github.repository_owner }}/mpcprompt-coordinator:latest' }
      - uses: docker/build-push-action@v6
        with: { context: '.', file: 'docker/Dockerfile.webui', push: true, tags: 'ghcr.io/${{ github.repository_owner }}/mpcprompt-webui:latest' }
      - if: ${{ secrets.AWS_ACCESS_KEY_ID && secrets.AWS_SECRET_ACCESS_KEY }}
        uses: aws-actions/configure-aws-credentials@v4
        with: { aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}, aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}, aws-region: ${{ env.AWS_REGION }} }
      - if: ${{ secrets.AWS_ACCOUNT_ID }}
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - if: ${{ steps.login-ecr.outputs.registry }}
        run: |
          COORD_TAG="${{ steps.login-ecr.outputs.registry }}/mpcprompt-coordinator:latest"
          WEBUI_TAG="${{ steps.login-ecr.outputs.registry }}/mpcprompt-webui:latest"
          docker tag ghcr.io/${{ github.repository_owner }}/mpcprompt-coordinator:latest "$COORD_TAG"
          docker tag ghcr.io/${{ github.repository_owner }}/mpcprompt-webui:latest "$WEBUI_TAG"
          docker push "$COORD_TAG"; docker push "$WEBUI_TAG"
      - if: ${{ secrets.OCIR_USERNAME && secrets.OCIR_AUTH_TOKEN && secrets.OCIR_REGION && secrets.OCIR_NAMESPACE }}
        uses: docker/login-action@v3
        with: { registry: ${{ secrets.OCIR_REGION }}.ocir.io, username: ${{ secrets.OCIR_USERNAME }}, password: ${{ secrets.OCIR_AUTH_TOKEN }} }
      - if: ${{ secrets.OCIR_NAMESPACE }}
        run: |
          REG="${{ secrets.OCIR_REGION }}.ocir.io"; NS="${{ secrets.OCIR_NAMESPACE }}"
          docker tag ghcr.io/${{ github.repository_owner }}/mpcprompt-coordinator:latest "$REG/$NS/mpcprompt-coordinator:latest"
          docker tag ghcr.io/${{ github.repository_owner }}/mpcprompt-webui:latest "$REG/$NS/mpcprompt-webui:latest"
          docker push "$REG/$NS/mpcprompt-coordinator:latest"; docker push "$REG/$NS/mpcprompt-webui:latest"


sbom:
  runs-on: ubuntu-latest
  needs: build-push
  steps:
    - uses: actions/checkout@v4
    - name: Generate SBOM (syft)
      uses: anchore/sbom-action@v0
      with:
        image: ghcr.io/${{ github.repository_owner }}/mpcprompt-coordinator:latest
        format: spdx-json
        output-file: sbom-coordinator.spdx.json
    - name: Upload SBOM artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom-coordinator
        path: sbom-coordinator.spdx.json
